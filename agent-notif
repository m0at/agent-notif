#!/usr/bin/env bash
set -euo pipefail

VERSION="0.1.0"
CONFIG_DIR="${HOME}/.config/agent-notif"
CONFIG_FILE="${CONFIG_DIR}/config"
DEFAULT_SERVER="https://ntfy.sh"

# Source labels with emoji
declare -A SOURCE_EMOJI=(
  [home]="ðŸ "
  [laptop]="ðŸ’»"
  [claude]="ðŸ¤–"
  [aws]="â˜ï¸"
  [do]="ðŸŒŠ"
  [lambda]="ðŸ§ "
)

# --- Config ---

load_config() {
  if [[ -f "$CONFIG_FILE" ]]; then
    # shellcheck source=/dev/null
    source "$CONFIG_FILE"
  fi
  NOTIF_SERVER="${NOTIF_SERVER:-$DEFAULT_SERVER}"
  NOTIF_TOPIC="${NOTIF_TOPIC:-}"
  NOTIF_SOURCE="${NOTIF_SOURCE:-$(hostname -s 2>/dev/null || echo "unknown")}"
  NOTIF_PRIORITY="${NOTIF_PRIORITY:-default}"
}

save_config() {
  mkdir -p "$CONFIG_DIR"
  cat > "$CONFIG_FILE" <<EOF
NOTIF_SERVER="$NOTIF_SERVER"
NOTIF_TOPIC="$NOTIF_TOPIC"
NOTIF_SOURCE="$NOTIF_SOURCE"
NOTIF_PRIORITY="$NOTIF_PRIORITY"
EOF
  chmod 600 "$CONFIG_FILE"
}

generate_topic() {
  # Generate a random topic name that's hard to guess
  local random
  if command -v openssl &>/dev/null; then
    random=$(openssl rand -hex 12)
  elif [[ -r /dev/urandom ]]; then
    random=$(head -c 12 /dev/urandom | xxd -p 2>/dev/null || od -An -tx1 /dev/urandom | head -1 | tr -d ' ')
  else
    random="$$-$(date +%s)-$RANDOM$RANDOM"
  fi
  echo "an-${random}"
}

# --- QR Code ---

print_qr_terminal() {
  local data="$1"
  if command -v qrencode &>/dev/null; then
    qrencode -t ANSIUTF8 "$data"
  elif command -v python3 &>/dev/null; then
    python3 -c "
import sys
try:
    import qrcode
    qr = qrcode.QRCode(box_size=1, border=1)
    qr.add_data(sys.argv[1])
    qr.print_ascii(invert=True)
except ImportError:
    print('[QR] Install qrcode: pip3 install qrcode')
    print(f'     Or install qrencode: brew install qrencode')
    print(f'     Manual URL: {sys.argv[1]}')
" "$data"
  else
    echo "[QR] No QR generator found."
    echo "     Install: brew install qrencode"
    echo "     Or: pip3 install qrcode"
    echo ""
    echo "     Manual URL: $data"
  fi
}

save_qr_png() {
  local data="$1"
  local outfile="$2"
  if command -v qrencode &>/dev/null; then
    qrencode -o "$outfile" -s 10 "$data"
    return 0
  elif command -v python3 &>/dev/null; then
    python3 -c "
import sys
try:
    import qrcode
    img = qrcode.make(sys.argv[1])
    img.save(sys.argv[2])
except ImportError:
    sys.exit(1)
" "$data" "$outfile" && return 0
  fi
  return 1
}

# --- Commands ---

cmd_setup() {
  local server="$DEFAULT_SERVER"
  local remote=false

  while [[ $# -gt 0 ]]; do
    case "$1" in
      --server) server="$2"; shift 2 ;;
      --remote) remote=true; shift ;;
      *) shift ;;
    esac
  done

  load_config

  if [[ -n "$NOTIF_TOPIC" ]] && [[ "$remote" == false ]]; then
    echo "Already configured. Topic: $NOTIF_TOPIC"
    echo "Server: $NOTIF_SERVER"
    echo ""
    read -rp "Regenerate topic? (y/N) " yn
    if [[ "$yn" != [yY]* ]]; then
      echo ""
      echo "To show QR again: agent-notif qr"
      return 0
    fi
  fi

  NOTIF_SERVER="$server"
  NOTIF_TOPIC="$(generate_topic)"
  save_config

  echo ""
  echo "=== agent-notif setup ==="
  echo ""
  echo "Topic:  $NOTIF_TOPIC"
  echo "Server: $NOTIF_SERVER"
  echo ""

  local subscribe_url="${NOTIF_SERVER}/${NOTIF_TOPIC}"

  echo "--- Scan this QR code to subscribe ---"
  echo ""
  print_qr_terminal "$subscribe_url"
  echo ""

  # Save PNG
  local qr_png="${CONFIG_DIR}/subscribe-qr.png"
  if save_qr_png "$subscribe_url" "$qr_png"; then
    echo "QR saved to: $qr_png"
  fi

  echo ""
  echo "--- Setup options ---"
  echo ""
  echo "Option 1: ntfy.sh app (recommended)"
  echo "  Install ntfy from App Store, then scan QR or open:"
  echo "  $subscribe_url"
  echo ""
  echo "Option 2: iOS Shortcuts (no app needed)"
  echo "  Run: agent-notif shortcut"
  echo ""
  echo "--- Test it ---"
  echo ""
  echo "  notif 'Hello from $(hostname -s 2>/dev/null || echo "setup")!'"
  echo ""
}

cmd_qr() {
  load_config
  if [[ -z "$NOTIF_TOPIC" ]]; then
    echo "Not configured yet. Run: agent-notif setup"
    return 1
  fi

  local subscribe_url="${NOTIF_SERVER}/${NOTIF_TOPIC}"
  echo ""
  echo "Subscribe URL: $subscribe_url"
  echo ""
  print_qr_terminal "$subscribe_url"

  local qr_png="${CONFIG_DIR}/subscribe-qr.png"
  if save_qr_png "$subscribe_url" "$qr_png"; then
    echo ""
    echo "QR PNG: $qr_png"
  fi
}

cmd_send() {
  load_config

  if [[ -z "$NOTIF_TOPIC" ]]; then
    echo "Not configured. Run: agent-notif setup" >&2
    return 1
  fi

  local message=""
  local source="$NOTIF_SOURCE"
  local priority="$NOTIF_PRIORITY"
  local title=""
  local tags=""

  while [[ $# -gt 0 ]]; do
    case "$1" in
      -s|--source) source="$2"; shift 2 ;;
      -p|--priority) priority="$2"; shift 2 ;;
      -t|--title) title="$2"; shift 2 ;;
      --tags) tags="$2"; shift 2 ;;
      -*) echo "Unknown flag: $1" >&2; return 1 ;;
      *) message="$1"; shift ;;
    esac
  done

  # Read from stdin if no message argument
  if [[ -z "$message" ]]; then
    if [[ ! -t 0 ]]; then
      message=$(cat)
    else
      echo "Usage: notif [-s source] [-p priority] \"message\"" >&2
      return 1
    fi
  fi

  # Build title from source
  local emoji="${SOURCE_EMOJI[$source]:-ðŸ“¡}"
  if [[ -z "$title" ]]; then
    title="${emoji} ${source}"
  fi

  # Build tag list
  if [[ -z "$tags" ]]; then
    tags="$source"
  fi

  # Send via curl
  local -a curl_args=(
    -s
    -o /dev/null
    -w "%{http_code}"
    -H "Title: ${title}"
    -H "Priority: ${priority}"
    -H "Tags: ${tags}"
    -d "$message"
    "${NOTIF_SERVER}/${NOTIF_TOPIC}"
  )

  local http_code
  http_code=$(curl "${curl_args[@]}" 2>/dev/null) || {
    echo "Failed to send notification (network error)" >&2
    return 1
  }

  if [[ "$http_code" == "200" ]]; then
    echo "Sent: ${emoji} ${message}"
  else
    echo "Failed (HTTP $http_code)" >&2
    return 1
  fi
}

cmd_shortcut() {
  load_config
  if [[ -z "$NOTIF_TOPIC" ]]; then
    echo "Not configured yet. Run: agent-notif setup"
    return 1
  fi

  echo ""
  echo "=== iOS Shortcuts Setup ==="
  echo ""
  echo "Since iOS Shortcuts can't directly listen for push notifications"
  echo "from ntfy.sh, here are two approaches:"
  echo ""
  echo "--- Approach 1: ntfy.sh App (easiest) ---"
  echo ""
  echo "Just install 'ntfy' from the App Store and subscribe to:"
  echo "  ${NOTIF_SERVER}/${NOTIF_TOPIC}"
  echo ""
  echo "--- Approach 2: Shortcuts Automation ---"
  echo ""
  echo "Create a Shortcut that checks for new messages:"
  echo ""
  echo "1. Open Shortcuts app"
  echo "2. Create new Shortcut:"
  echo "   - Action: 'Get Contents of URL'"
  echo "     URL: ${NOTIF_SERVER}/${NOTIF_TOPIC}/json?poll=1&since=5m"
  echo "   - Action: 'Get Dictionary Value' (key: 'message')"
  echo "   - Action: 'Show Notification'"
  echo "3. Set up Automation:"
  echo "   - Trigger: 'Time of Day' â†’ every 5 minutes"
  echo "   - Action: Run your Shortcut"
  echo ""
  echo "--- Approach 3: Shortcuts + Focus Filter ---"
  echo ""
  echo "For instant notifications without polling:"
  echo "1. Install ntfy app (for push delivery)"
  echo "2. Create a Shortcut triggered by ntfy notification"
  echo "3. The Shortcut can then log, filter, or forward notifications"
  echo ""
  echo "Topic for all methods: ${NOTIF_TOPIC}"
  echo "Server: ${NOTIF_SERVER}"
  echo ""
}

cmd_config() {
  load_config
  echo "Server:   ${NOTIF_SERVER}"
  echo "Topic:    ${NOTIF_TOPIC:-<not set>}"
  echo "Source:   ${NOTIF_SOURCE}"
  echo "Priority: ${NOTIF_PRIORITY}"
  echo "Config:   ${CONFIG_FILE}"
}

cmd_test() {
  load_config
  if [[ -z "$NOTIF_TOPIC" ]]; then
    echo "Not configured yet. Run: agent-notif setup"
    return 1
  fi
  cmd_send -s "test" -p "default" "Test notification from $(hostname -s 2>/dev/null || echo "agent-notif") at $(date '+%H:%M:%S')"
}

cmd_usage() {
  cat <<EOF
agent-notif v${VERSION} â€” Push notifications from any machine to iPhone

Usage:
  agent-notif <command> [options]
  notif [options] "message"          (shorthand for send)

Commands:
  setup [--server URL] [--remote]    First-time setup, generates QR
  send  [-s source] [-p pri] "msg"   Send a notification
  qr                                 Show subscribe QR code again
  shortcut                           iOS Shortcut setup instructions
  config                             Show current configuration
  test                               Send a test notification
  help                               Show this help

Send options:
  -s, --source NAME    Source label (home|laptop|claude|aws|do|lambda|custom)
  -p, --priority PRI   Priority (min|low|default|high|max)
  -t, --title TEXT     Custom title (default: source name)
  --tags TAGS          Comma-separated tags

Examples:
  notif "Build done"
  notif -s claude -p high "Refactor complete: 47 files changed"
  notif -s aws "Deploy to prod finished"
  echo "Pipeline done" | notif -s lambda
EOF
}

# --- Main ---

main() {
  local cmd="${1:-help}"
  shift 2>/dev/null || true

  case "$cmd" in
    setup)    cmd_setup "$@" ;;
    send)     cmd_send "$@" ;;
    qr)       cmd_qr ;;
    shortcut) cmd_shortcut ;;
    config)   cmd_config ;;
    test)     cmd_test ;;
    help|--help|-h) cmd_usage ;;
    version|--version|-v) echo "agent-notif v${VERSION}" ;;
    # If first arg isn't a command, treat it as a message (notif alias)
    *)        cmd_send "$cmd" "$@" ;;
  esac
}

main "$@"
