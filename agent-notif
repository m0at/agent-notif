#!/usr/bin/env bash
set -euo pipefail

VERSION="0.3.0"
CONFIG_DIR="${HOME}/.config/agent-notif"
CONFIG_FILE="${CONFIG_DIR}/config"
AMAIL_SETTINGS="${HOME}/amail/settings.json"

# Source labels with emoji
declare -A SOURCE_EMOJI=(
  [home]="ðŸ "
  [laptop]="ðŸ’»"
  [claude]="ðŸ¤–"
  [aws]="â˜ï¸"
  [do]="ðŸŒŠ"
  [lambda]="ðŸ§ "
  [test]="ðŸ§ª"
)

# --- amail config reader ---

amail_get() {
  local key="$1"
  python3 -c "
import json
with open('$AMAIL_SETTINGS') as f:
    cfg = json.load(f)
d = cfg['domains'][0]
keys = {
    'server_ip': d['server_ip'],
    'domain': d['domain'],
    'from': d['email_accounts'][0]['address'],
    'to': d['email_accounts'][0]['address'],
}
print(keys.get('$key', ''))
" 2>/dev/null
}

# --- Config ---

load_config() {
  if [[ -f "$CONFIG_FILE" ]]; then
    # shellcheck source=/dev/null
    source "$CONFIG_FILE"
  fi

  NOTIF_SOURCE="${NOTIF_SOURCE:-$(hostname -s 2>/dev/null || echo "unknown")}"
  NOTIF_TRANSPORT="${NOTIF_TRANSPORT:-email}"

  # Email config (from amail)
  if [[ "$NOTIF_TRANSPORT" == "email" ]] && [[ -f "$AMAIL_SETTINGS" ]]; then
    NOTIF_SMTP_HOST="${NOTIF_SMTP_HOST:-$(amail_get server_ip)}"
    NOTIF_FROM="${NOTIF_FROM:-$(amail_get from)}"
    NOTIF_TO="${NOTIF_TO:-$(amail_get to)}"
  fi

  # ntfy fallback
  NOTIF_SERVER="${NOTIF_SERVER:-https://ntfy.sh}"
  NOTIF_TOPIC="${NOTIF_TOPIC:-}"
}

save_config() {
  mkdir -p "$CONFIG_DIR"
  cat > "$CONFIG_FILE" <<EOF
NOTIF_TRANSPORT="$NOTIF_TRANSPORT"
NOTIF_SOURCE="$NOTIF_SOURCE"

# Email transport (reads from amail settings.json by default)
# Override here if needed:
# NOTIF_SMTP_HOST=""
# NOTIF_FROM=""
# NOTIF_TO=""

# ntfy transport (optional fallback)
NOTIF_SERVER="$NOTIF_SERVER"
NOTIF_TOPIC="$NOTIF_TOPIC"
EOF
  chmod 600 "$CONFIG_FILE"
}

# --- Send via direct SMTP (python3, no SSH needed) ---

send_email() {
  local subject="$1"
  local body="$2"

  python3 -c "
import smtplib
from email.mime.text import MIMEText

msg = MIMEText('''$body''')
msg['From'] = '$NOTIF_FROM'
msg['To'] = '$NOTIF_TO'
msg['Subject'] = '$subject'
msg['X-Agent-Notif'] = '1'

with smtplib.SMTP('$NOTIF_SMTP_HOST', 25, timeout=10) as smtp:
    smtp.send_message(msg)
" 2>/dev/null
}

# --- Send via ntfy (optional fallback) ---

send_ntfy() {
  local title="$1"
  local message="$2"
  local priority="${3:-default}"
  local tags="${4:-}"

  curl -s -o /dev/null -w "%{http_code}" \
    -H "Title: ${title}" \
    -H "Priority: ${priority}" \
    -H "Tags: ${tags}" \
    -d "$message" \
    "${NOTIF_SERVER}/${NOTIF_TOPIC}" 2>/dev/null
}

# --- Commands ---

cmd_setup() {
  load_config

  echo ""
  echo "=== agent-notif setup ==="
  echo ""

  if [[ -f "$AMAIL_SETTINGS" ]]; then
    echo "Found amail config: $AMAIL_SETTINGS"
    echo "  SMTP: ${NOTIF_SMTP_HOST}:25"
    echo "  From: ${NOTIF_FROM}"
    echo "  To:   ${NOTIF_TO}"
    echo ""
    NOTIF_TRANSPORT="email"
    echo "Transport: direct SMTP to amail server"
  else
    echo "No amail settings found at $AMAIL_SETTINGS"
    echo "Falling back to ntfy.sh transport"
    echo ""
    NOTIF_TRANSPORT="ntfy"
    if [[ -z "$NOTIF_TOPIC" ]]; then
      local random
      random=$(openssl rand -hex 12 2>/dev/null || echo "$$-$(date +%s)-$RANDOM")
      NOTIF_TOPIC="an-${random}"
    fi
  fi

  save_config

  echo ""
  echo "--- iPhone setup ---"
  echo ""

  if [[ "$NOTIF_TRANSPORT" == "email" ]]; then
    echo "1. On iPhone â†’ Mail â†’ mark ${NOTIF_FROM} as VIP"
    echo "   (VIP emails get banner notifications + custom sound)"
    echo ""
    echo "2. OR: Shortcuts â†’ Automation â†’ Mail"
    echo "   Trigger: Subject contains '[notif]'"
    echo "   Action:  Show Notification"
    echo ""
    echo "That's it. Zero apps to install."
  else
    local url="${NOTIF_SERVER}/${NOTIF_TOPIC}"
    echo "Scan QR to subscribe in ntfy app:"
    echo "URL: $url"
  fi

  echo ""
  echo "--- Test it ---"
  echo ""
  echo "  notif 'Hello from $(hostname -s 2>/dev/null || echo "setup")!'"
  echo ""
}

cmd_send() {
  load_config

  local message=""
  local source="$NOTIF_SOURCE"
  local priority="default"

  while [[ $# -gt 0 ]]; do
    case "$1" in
      -s|--source) source="$2"; shift 2 ;;
      -p|--priority) priority="$2"; shift 2 ;;
      -*) echo "Unknown flag: $1" >&2; return 1 ;;
      *) message="$1"; shift ;;
    esac
  done

  if [[ -z "$message" ]]; then
    if [[ ! -t 0 ]]; then
      message=$(cat)
    else
      echo "Usage: notif [-s source] [-p priority] \"message\"" >&2
      return 1
    fi
  fi

  local emoji="${SOURCE_EMOJI[$source]:-ðŸ“¡}"
  local subject="[notif] ${emoji} ${source}: ${message}"

  if [[ "$NOTIF_TRANSPORT" == "email" ]]; then
    if [[ -z "${NOTIF_SMTP_HOST:-}" ]]; then
      echo "Email not configured. Run: agent-notif setup" >&2
      return 1
    fi

    local body="${message}

--
source: ${source}
host:   $(hostname -s 2>/dev/null || echo unknown)
time:   $(date '+%Y-%m-%d %H:%M:%S %Z')
pri:    ${priority}"

    if send_email "$subject" "$body"; then
      echo "Sent: ${emoji} ${message}"
    else
      echo "Failed (SMTP error â€” is ${NOTIF_SMTP_HOST}:25 reachable?)" >&2
      return 1
    fi

  elif [[ "$NOTIF_TRANSPORT" == "ntfy" ]]; then
    if [[ -z "${NOTIF_TOPIC:-}" ]]; then
      echo "ntfy not configured. Run: agent-notif setup" >&2
      return 1
    fi

    local http_code
    http_code=$(send_ntfy "${emoji} ${source}" "$message" "$priority" "$source") || {
      echo "Failed (network error)" >&2
      return 1
    }

    if [[ "$http_code" == "200" ]]; then
      echo "Sent: ${emoji} ${message}"
    else
      echo "Failed (HTTP $http_code)" >&2
      return 1
    fi
  fi
}

cmd_config() {
  load_config
  echo "Transport: ${NOTIF_TRANSPORT}"
  echo "Source:    ${NOTIF_SOURCE}"
  echo "Config:    ${CONFIG_FILE}"
  echo ""
  if [[ "$NOTIF_TRANSPORT" == "email" ]]; then
    echo "SMTP: ${NOTIF_SMTP_HOST:-<not set>}:25"
    echo "From: ${NOTIF_FROM:-<not set>}"
    echo "To:   ${NOTIF_TO:-<not set>}"
  else
    echo "ntfy Server: ${NOTIF_SERVER}"
    echo "ntfy Topic:  ${NOTIF_TOPIC:-<not set>}"
  fi
}

cmd_test() {
  load_config
  cmd_send -s "test" "Test from $(hostname -s 2>/dev/null || echo "agent-notif") at $(date '+%H:%M:%S')"
}

cmd_usage() {
  cat <<EOF
agent-notif v${VERSION} â€” Push notifications from any machine to iPhone

Zero APIs. Sends email direct to your amail SMTP server.
iPhone notifies via Mail VIP or Shortcuts automation.

Usage:
  agent-notif <command> [options]
  notif [options] "message"          (shorthand for send)

Commands:
  setup                              First-time setup (auto-detects amail)
  send  [-s source] [-p pri] "msg"   Send a notification
  config                             Show current configuration
  test                               Send a test notification
  help                               Show this help

Send options:
  -s, --source NAME    Source label (home|laptop|claude|aws|do|lambda|custom)
  -p, --priority PRI   Priority (low|default|high)

Examples:
  notif "Build done"
  notif -s claude -p high "Refactor complete: 47 files changed"
  notif -s aws "Deploy to prod finished"
  echo "Pipeline done" | notif -s lambda
EOF
}

# --- Main ---

main() {
  local cmd="${1:-help}"
  shift 2>/dev/null || true

  case "$cmd" in
    setup)    cmd_setup "$@" ;;
    send)     cmd_send "$@" ;;
    config)   cmd_config ;;
    test)     cmd_test ;;
    help|--help|-h) cmd_usage ;;
    version|--version|-v) echo "agent-notif v${VERSION}" ;;
    *)        cmd_send "$cmd" "$@" ;;
  esac
}

main "$@"
